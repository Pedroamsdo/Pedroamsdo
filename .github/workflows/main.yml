# local uploaded file (for your reference / tool transformation):
# /mnt/data/0963A7BB-5101-4AC7-9988-B5802BC612F7.png

name: generate animation (no token, public contributions only)

on:
  # run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main   # altere para 'master' se seu repo usar master

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure dist dir exists
        run: |
          mkdir -p dist

      # Use Platane/snk WITHOUT token -> will include only public contributions
      - name: Generate snake SVGs (public contributions only)
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg

      - name: Confirm generation
        run: |
          echo "Files in dist:"
          ls -la dist || true

      # If Platane/snk produced different default colors, force-replace base color to the blue hex below
      - name: Make snake blue (safe replacement)
        run: |
          BLUE=1E90FF
          # Try replacing common black/grey snake colors with chosen blue;
          # this sed approach is robust for basic SVG color attributes.
          for f in dist/*.svg; do
            if [ -f "$f" ]; then
              # replace common hex/color names (add more patterns if needed)
              sed -i "s/#000000/#$BLUE/g" "$f" || true
              sed -i "s/#111111/#$BLUE/g" "$f" || true
              sed -i "s/#222222/#$BLUE/g" "$f" || true
              sed -i "s/black/#$BLUE/g" "$f" || true
              sed -i "s/rgb(0,0,0)/#${BLUE}/g" "$f" || true
            fi
          done
          echo "Tinting complete."

      # If the output branch doesn't exist, create it (use a temporary clone to avoid race)
      - name: Push dist to output branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          TMPDIR=$(mktemp -d)
          git clone --branch=output --single-branch "$REPO" "$TMPDIR" 2>/dev/null || {
            # branch doesn't exist -> create orphan branch
            git clone "$REPO" "$TMPDIR"
            cd "$TMPDIR"
            git checkout --orphan output
            git rm -rf .
            git commit --allow-empty -m "create output branch"
            git push "$REPO" output
            cd -
          }
          cd "$TMPDIR"
          # copy new files into clone working tree
          rm -rf ./*
          cp -r $GITHUB_WORKSPACE/dist/* .
          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update contribution snake (blue) - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push "$REPO" output
          cd -
          rm -rf "$TMPDIR"

      - name: Done
        run: echo "Snake generation complete â€” public contributions only (no PERSONAL_TOKEN used)."
